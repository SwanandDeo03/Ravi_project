<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <title>Fields Group - Expenses Voucher</title>
    <link rel="stylesheet" href="css/style.css" />
</head>

<body>

    <!-- SIDE MENU -->
    <div id="sideMenu" class="side-menu" aria-hidden="true">
        <div class="menu-top">
            <img src="img/Fields-Group.png" class="menu-logo" />
            <button id="closeMenu" class="close-btn">✕</button>
        </div>

        <nav class="menu-list" id="menuList">
            <a class="menu-item active" onclick="Dashboard()">Home</a>
            <a class="menu-item" onclick="profile()">Profile</a>
            <a class="menu-item" onclick="leaveApplication()">Leave Application</a>
            <a class="menu-item" onclick="leaveReport()">Leave Report</a>

            <a class="menu-item" onclick="lead()">Lead Genration</a>
            <a class="menu-item" onclick="leadReport()">Lead Report</a>

            <a class="menu-item" onclick="service()">Service Enquiry</a>
            <a class="menu-item" onclick="serviceReport()">Service Report</a>

            <!--<a class="menu-item">Tracking</a>
    <a class="menu-item" onclick="ExpensesVoucher()">Expenses Voucher</a>-->
            <a class="menu-item" onclick="travel()">Travelling / Daily Allow</a>
            <a class="menu-item" onclick="travelReport()">Allowances Report</a>
            <a class="menu-item" onclick="logout()">Log Out</a>
        </nav>
    </div>

    <!-- MAIN PAGE -->
    <div id="mainPage" class="page">
        <header class="topbar">
            <button id="openMenu" class="hamb">☰</button>
           
        </header>

        <!-- USER CARD -->
        <section class="user-card">
            <div>
                <h3>Expenses Voucher</h3>
                <h4 hidden id="empName"></h4>
                <small><span hidden id="empId"></span></small>
            </div>
        </section>

        <!-- FORM -->
        <section class="login-card">
            <div>
                <label>Name Dr / Cr</label>
                <input id="Name_Dr_Cr" type="text">

                <label>Narration</label>
                <input id="Narration" type="text">

                <label>Amount of Rs.</label>
                <input id="Amount_Of_Rs" type="text">

                <label>Voucher Date</label>
                <label for="From_Date_display">(DD/MM/YYYY)</label>
                <input id="From_Date_display" type="text" class="input" placeholder="DD/MM/YYYY" readonly />

                <input id="From_Date" class="native-date" type="date" />

                <button id="Submit">Submit</button>
            </div>
        </section>
    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
        <a onclick="Dashboard()">🏠</a>
        <a onclick="profile()">👤</a>
        <a onclick="leaveReport()">🧾</a>
        <a onclick="alert('Settings')">⚙️</a>
    </div>

    <!-- Cordova Loader -->
    <script>
        (function () {
            var s = document.createElement('script');
            s.src = 'cordova.js';
            document.head.appendChild(s);
        })();
    </script>

    <!-- MENU JS -->
    <script src="js/menu.js"></script>

    <!-- PAGE JS -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            let user = null;
            try {
                user = JSON.parse(localStorage.getItem("emp_user"));
            } catch { }

            if (!user || !user.emp_id) {
                alert("No logged-in user found.");
                return;
            }

            document.getElementById("empName").innerText = user.emp_name;
            document.getElementById("empId").innerText = user.emp_id;

            // SIDE MENU
            const sideMenu = document.getElementById('sideMenu');
            document.getElementById('openMenu').onclick = () =>
                sideMenu.classList.add('open');
            document.getElementById('closeMenu').onclick = () =>
                sideMenu.classList.remove('open');

            // DATE HANDLING
            const fromNative = document.getElementById("From_Date");
            const fromDisplay = document.getElementById("From_Date_display");

            function formatToDDMMYYYY(isoDate) {
                if (!isoDate) return "";
                const parts = isoDate.split("-");
                return `${parts[2]}/${parts[1]}/${parts[0]}`;
            }

            function setTodayFor(nativeEl, displayEl) {
                const now = new Date();
                const dd = String(now.getDate()).padStart(2, '0');
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const yyyy = now.getFullYear();
                const iso = `${yyyy}-${mm}-${dd}`;
                nativeEl.value = iso;
                displayEl.value = formatToDDMMYYYY(iso);
            }

            setTodayFor(fromNative, fromDisplay);

            fromNative.addEventListener("change", function () {
                fromDisplay.value = formatToDDMMYYYY(fromNative.value);
            });

            function openNativePicker(displayEl, nativeEl) {
                displayEl.addEventListener("click", function () {
                    if (typeof nativeEl.showPicker === "function") {
                        nativeEl.showPicker();
                    } else {
                        nativeEl.focus();
                        nativeEl.click();
                    }
                });
            }

            openNativePicker(fromDisplay, fromNative);
        });
    </script>

    <script>
        document.getElementById("Submit").addEventListener("click", async function () {

            let user = null;
            try {
                user = JSON.parse(localStorage.getItem("emp_user"));
            } catch { }

            if (!user || !user.emp_id) {
                alert("No logged-in user found. Please login again.");
                return;
            }

            let emp_id = user.emp_id;
            let Name_Dr_Cr = document.getElementById("Name_Dr_Cr").value.trim();
            let Narration = document.getElementById("Narration").value.trim();
            let Amount_Of_Rs = document.getElementById("Amount_Of_Rs").value.trim();

            // GET DATE
            let VoucherDate = document.getElementById("From_Date").value.trim();

            // FIX: fallback if native date picker does not return value
            if (!VoucherDate) {
                let ddmmyyyy = document.getElementById("From_Date_display").value;
                let parts = ddmmyyyy.split("/");
                if (parts.length === 3) {
                    VoucherDate = `${parts[2]}-${parts[1]}-${parts[0]}`; // YYYY-MM-DD
                }
            }

            if (!Name_Dr_Cr || !Narration || !Amount_Of_Rs || !VoucherDate) {
                alert("Please fill all fields.");
                return;
            }

            let formData = new FormData();
            formData.append("emp_id", emp_id);
            formData.append("CustomerName", Name_Dr_Cr);
            formData.append("Narration", Narration);
            formData.append("Amount", Amount_Of_Rs);
            formData.append("VoucherDate", VoucherDate);

            try {
                const response = await fetch("https://empapp.kaizensoftware.in/api/Expenses/Add_Expenses_Voucher", {
                    method: "POST",
                    body: formData
                });

                // Attempt to parse JSON safely; if parsing fails, fallback to text
                let data;
                const contentType = response.headers.get("content-type") || "";
                if (contentType.indexOf("application/json") !== -1) {
                    data = await response.json();
                } else {
                    const text = await response.text();
                    // try parse anyway, else wrap into an object
                    try { data = JSON.parse(text); } catch { data = { ResponseMessage: text || (response.ok ? "Success" : "Server error"), ResponseCode: response.ok ? 101 : 500 }; }
                }

                // Prefer server message, fallback to generic
                const msg = (data && (data.ResponseMessage || data.responseMessage || data.message)) || "No response message from server";
                alert(msg);

                if (data && (data.ResponseCode === 101 || response.ok && data.ResponseCode === undefined)) {
                    // success path - redirect if server reported 101
                    //window.location.href = "Expenses_Voucher.html";
                    location.reload();
                }
            } catch (err) {
                console.error("API Error:", err);
                alert("Something went wrong! Please try again.");
            }
        });
    </script>

</body>
</html>
